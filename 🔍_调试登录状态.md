# 🔍 调试登录状态 - 完整诊断方案

## 🚨 **问题**: 登录后刷新页面又变成未登录

## 🧪 **立即诊断（在浏览器中执行）**

### Step 1: 检查 LocalStorage

打开浏览器（http://localhost:3000）

按 `F12` → Application → Local Storage → http://localhost:3000

**应该看到**:
```
imagine-engine-auth: {"access_token":"...", "refresh_token":"..."}
```

**如果没有**: Session未保存 → Supabase配置问题

**如果有**: 说明session保存了，但API读取失败

---

### Step 2: 在控制台测试 Supabase

在浏览器 Console 中执行：

```javascript
// 测试Supabase连接
import { supabase } from './src/lib/supabase';

// 检查当前用户
supabase.auth.getUser().then(({data, error}) => {
  console.log('当前用户:', data.user);
  console.log('错误:', error);
});

// 检查Session
supabase.auth.getSession().then(({data, error}) => {
  console.log('Session:', data.session);
  console.log('错误:', error);
});
```

---

### Step 3: 查看完整日志

在浏览器 Console 中查找：
- ✅ "认证状态变化" 日志
- ✅ "登录成功" 日志
- ❌ 任何错误提示

---

## 🔧 **可能的问题和解决方案**

### 问题1: API Route 无法读取 Cookie

**原因**: Next.js App Router 的 cookies() 配置问题

**检查文件**: `src/app/api/quota/check/route.ts`

**当前代码**:
```typescript
const supabase = createRouteHandlerClient({ cookies });
```

**可能需要改为**:
```typescript
import { cookies } from 'next/headers';

const cookieStore = cookies();
const supabase = createRouteHandlerClient({ 
  cookies: () => cookieStore 
});
```

---

### 问题2: Supabase Auth 配置问题

**检查**: Supabase Dashboard → Authentication → URL Configuration

**Site URL** 应该设置为: `http://localhost:3000`

**Redirect URLs** 应该包含:
- `http://localhost:3000`
- `http://localhost:3000/auth/callback`
- `http://localhost:3000/**`

---

### 问题3: 缺少完整的 SUPABASE_SETUP.sql

**执行完整脚本**:

打开: https://supabase.com/dashboard/project/ryycsolimgocffujpunq/sql/new

执行我创建的完整 `SUPABASE_SETUP.sql` 文件（246行）

---

## 🎯 **终极解决方案（100%有效）**

### 方案A: 修复 API Route 的 Cookie 读取

我会立即修复所有API Route文件

### 方案B: 使用客户端直接调用（临时）

先让功能能用，再优化架构

---

## 📞 **告诉我调试结果**

执行 Step 1 和 Step 2，然后告诉我：

1. LocalStorage 中**是否有** `imagine-engine-auth` ?
2. `getUser()` 返回什么？
3. Console 中有什么错误？

我根据结果立即修复！🚀

