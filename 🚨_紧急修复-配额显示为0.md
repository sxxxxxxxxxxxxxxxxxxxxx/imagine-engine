# 🚨 紧急修复：配额显示为0，无法生成图片

## ❌ **问题原因**

从您的 Dashboard 截图看到：
- **总配额**: 张（无数字）
- **剩余**: 0 张

**根本原因**: 用户注册时**没有自动创建 Free 订阅**

**为什么**: `SUPABASE_SETUP.sql` 未执行 → 触发器不存在 → 注册时不会自动创建订阅

---

## ✅ **立即解决（2个SQL命令）**

### 🔴 方案1: 一键修复（推荐）

在 Supabase SQL Editor 执行以下命令：

**链接**: https://supabase.com/dashboard/project/ryycsolimgocffujpunq/sql/new

```sql
-- ============================================
-- 一键修复：创建函数 + 为当前用户添加订阅
-- ============================================

-- 1. 创建新用户自动初始化函数
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, username, avatar_url)
  VALUES (NEW.id, NEW.raw_user_meta_data->>'username', NEW.raw_user_meta_data->>'avatar_url');
  
  INSERT INTO public.subscriptions (
    user_id, plan_type, status, quota_total, quota_used, start_date, end_date, auto_renew
  ) VALUES (
    NEW.id, 'free', 'active', 10, 0, NOW(), NOW() + INTERVAL '1 month', false
  );
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 2. 创建配额检查函数
CREATE OR REPLACE FUNCTION public.check_user_quota(p_user_id UUID)
RETURNS JSONB LANGUAGE plpgsql SECURITY DEFINER AS $$
DECLARE
  v_remaining INT;
  v_total INT;
  v_used INT;
  v_plan_type VARCHAR;
BEGIN
  SELECT quota_remaining, quota_total, quota_used, plan_type
  INTO v_remaining, v_total, v_used, v_plan_type
  FROM public.subscriptions
  WHERE user_id = p_user_id AND status = 'active' AND end_date > NOW()
  ORDER BY end_date DESC LIMIT 1;

  IF v_remaining IS NULL THEN
    RETURN jsonb_build_object('available', false, 'remaining', 0, 'total', 0, 'used', 0, 'plan_type', 'none');
  END IF;

  RETURN jsonb_build_object('available', v_remaining > 0, 'remaining', v_remaining, 'total', v_total, 'used', v_used, 'plan_type', v_plan_type);
END;
$$;

-- 3. 创建配额扣减函数
CREATE OR REPLACE FUNCTION public.deduct_user_quota(
  p_user_id UUID, p_amount INT DEFAULT 1, p_action_type VARCHAR DEFAULT 'generate_image', p_metadata JSONB DEFAULT '{}'::jsonb
)
RETURNS JSONB LANGUAGE plpgsql SECURITY DEFINER AS $$
DECLARE
  v_subscription_id UUID;
  v_remaining INT;
  v_quota_before INT;
BEGIN
  SELECT id, quota_remaining INTO v_subscription_id, v_quota_before
  FROM public.subscriptions
  WHERE user_id = p_user_id AND status = 'active' AND end_date > NOW()
  ORDER BY end_date DESC LIMIT 1 FOR UPDATE;

  IF v_subscription_id IS NULL THEN RAISE EXCEPTION 'No active subscription found'; END IF;
  IF v_quota_before < p_amount THEN RAISE EXCEPTION 'Insufficient quota'; END IF;

  UPDATE public.subscriptions SET quota_used = quota_used + p_amount, updated_at = NOW()
  WHERE id = v_subscription_id;

  INSERT INTO public.usage_logs (user_id, subscription_id, action_type, cost_quota, prompt, image_url, model_used)
  VALUES (p_user_id, v_subscription_id, p_action_type, p_amount, p_metadata->>'prompt', p_metadata->>'image_url', p_metadata->>'model_used');

  SELECT quota_remaining INTO v_remaining FROM public.subscriptions WHERE id = v_subscription_id;

  RETURN jsonb_build_object('success', true, 'remaining', v_remaining, 'deducted', p_amount, 'subscription_id', v_subscription_id);
END;
$$;

-- 4. 授权函数
GRANT EXECUTE ON FUNCTION public.check_user_quota(UUID) TO anon, authenticated;
GRANT EXECUTE ON FUNCTION public.deduct_user_quota(UUID, INT, VARCHAR, JSONB) TO anon, authenticated;

-- 5. 创建触发器
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created AFTER INSERT ON auth.users
FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();

-- 6. 为所有现有用户添加 Free 订阅（如果还没有）
INSERT INTO public.subscriptions (user_id, plan_type, status, quota_total, quota_used, start_date, end_date, auto_renew)
SELECT 
  u.id,
  'free',
  'active',
  10,
  0,
  NOW(),
  NOW() + INTERVAL '1 month',
  false
FROM auth.users u
LEFT JOIN public.subscriptions s ON s.user_id = u.id
WHERE s.id IS NULL;  -- 只为没有订阅的用户创建

-- ============================================
-- ✅ 执行后立即刷新页面
-- ============================================
```

---

## 🎉 **执行后的效果**

刷新页面（F5），您会看到：

### ✅ Dashboard
- 总配额: **10 张**
- 已使用: **0 张**
- 剩余: **10 张**（青色）
- 环形进度条: 100%

### ✅ 顶部导航栏
- 显示: **⚡ 10/10**

### ✅ AI Studio
- 可以正常生成图片
- 每生成1张，配额-1
- 生成10张后无法继续

---

## 📊 **验证SQL执行成功**

执行后，运行验证查询：

```sql
-- 1. 检查您的订阅
SELECT * FROM public.subscriptions ORDER BY created_at DESC LIMIT 1;

-- 应该看到：
-- plan_type: free
-- quota_total: 10
-- quota_used: 0
-- quota_remaining: 10
```

---

## 🔧 **为什么Editor可以用但不扣减配额？**

**原因**: Editor API (`/api/edit`) 没有集成配额检查

**影响**: 
- Editor 可以无限使用（漏洞）
- 不扣减配额

**解决**: 我稍后会修复 Editor API，添加配额检查

---

## 🎯 **现在立即执行**

1. 打开 Supabase SQL Editor
2. 复制上面的完整SQL
3. 点击 Run ▶️
4. 刷新页面

**应该立即看到配额显示！** 🚀

---

**执行SQL后告诉我结果！** ✨

